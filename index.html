<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GreenPay | Premium Market</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        :root { 
            --green: #00ff88; 
            --green-dark: #00bd65;
            --dark-bg: #0a0a0a; 
            --card-bg: rgba(25, 25, 25, 0.8);
            --text: #e0e0e0; 
            --admin: #ff4757;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--dark-bg); 
            color: var(--text); 
            margin: 0; 
            line-height: 1.6;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% -20%, #1a3a2a 0%, #0a0a0a 100%);
            background-attachment: fixed;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        nav { 
            background: rgba(0, 0, 0, 0.8); 
            backdrop-filter: blur(10px);
            padding: 0 20px; 
            display: flex; 
            align-items: center; 
            height: 70px; 
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            justify-content: space-between; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }

        .logo { font-size: 20px; font-weight: 900; color: var(--green); letter-spacing: 1px; }

        .nav-links { display: flex; gap: 15px; }
        .nav-links span { 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 700; 
            text-transform: uppercase;
            opacity: 0.6; 
            transition: 0.3s;
            position: relative;
            padding: 5px 0;
        }
        .nav-links span.active { opacity: 1; color: var(--green); }
        .dot::after { content: ''; position: absolute; top: 0; right: -10px; width: 6px; height: 6px; background: var(--admin); border-radius: 50%; border: 2px solid var(--dark-bg); }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { 
            background: var(--card-bg); 
            backdrop-filter: blur(5px);
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid var(--glass); 
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        .product { 
            background: var(--card-bg); 
            border: 1px solid var(--glass);
            border-radius: 20px; 
            padding: 24px; 
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product:hover { border-color: var(--green); transform: translateY(-5px); }
        .product h3 { margin: 0 0 10px 0; color: #fff; font-size: 18px; }
        .price { font-size: 24px; font-weight: 800; color: var(--green); margin: 15px 0; }
        
        /* –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã */
        input, select, button { 
            width: 100%; padding: 14px; margin: 10px 0; 
            border-radius: 12px; border: 1px solid #333; 
            background: #1a1a1a; color: white; 
            font-size: 15px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--green); background: #222; }
        
        button { 
            background: linear-gradient(135deg, var(--green), var(--green-dark)); 
            color: #000; font-weight: 800; border: none; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 1px;
        }
        button:active { transform: scale(0.98); }
        button.secondary { background: #333; color: #fff; }

        /* –ß–∞—Ç */
        .chat-wrap { 
            display: flex; height: 70vh; background: var(--card-bg); 
            border-radius: 20px; border: 1px solid var(--glass); overflow: hidden; 
        }
        .chat-list { width: 250px; background: rgba(0,0,0,0.3); border-right: 1px solid var(--glass); overflow-y: auto; }
        .chat-item { padding: 15px; border-bottom: 1px solid var(--glass); cursor: pointer; transition: 0.2s; }
        .chat-item:hover { background: var(--glass); }
        .chat-item.unread { border-left: 4px solid var(--green); background: rgba(0,255,136,0.05); }

        .chat-main { flex-grow: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); }
        .messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 14px; position: relative; }
        .msg.me { align-self: flex-end; background: var(--green); color: #000; border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-start; background: #333; color: #fff; border-bottom-left-radius: 4px; }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        .admin-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; background: rgba(255,255,255,0.02); 
            border-radius: 12px; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
        @media (max-width: 768px) {
            nav { padding: 0 10px; height: 60px; }
            .logo { font-size: 16px; }
            .nav-links { gap: 8px; }
            .nav-links span { font-size: 10px; }
            .chat-wrap { flex-direction: column; height: 85vh; }
            .chat-list { width: 100%; height: 150px; border-right: none; border-bottom: 1px solid var(--glass); }
            .grid { grid-template-columns: 1fr; }
            .container { padding: 10px; }
        }

        #auth-overlay { 
            position: fixed; inset: 0; background: var(--dark-bg); z-index: 2000; 
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="card" style="width: 100%; max-width: 360px; text-align: center;">
        <h1 style="color: var(--green); margin-top: 0;">GreenPay</h1>
        <p style="opacity: 0.5; font-size: 14px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
        <input type="text" id="nick-in" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <input type="password" id="pass-in" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="handleAuth()">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
    </div>
</div>

<nav>
    <div class="logo">GREENPAY <span id="adm-badge" style="display:none; color:var(--admin); font-size: 10px;">‚Ä¢ ADMIN</span></div>
    <div class="nav-links">
        <span class="active" onclick="setPage('market', this)">–ú–∞—Ä–∫–µ—Ç</span>
        <span onclick="setPage('sell', this)">–ü—Ä–æ–¥–∞—Ç—å</span>
        <span id="chat-link" onclick="setPage('chats', this)">–ß–∞—Ç—ã</span>
        <span id="adm-link" style="display:none; color:var(--admin)" onclick="setPage('adm-page', this)">–ê–¥–º–∏–Ω</span>
        <span onclick="logout()" style="opacity: 0.4;">–í—ã—Ö–æ–¥</span>
    </div>
</nav>

<div class="container">
    <div id="market" class="page active">
        <h2 style="margin-bottom: 30px;">–í–∏—Ç—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <div id="market-render" class="grid"></div>
    </div>

    <div id="sell" class="page">
        <div class="card" style="max-width: 500px; margin: 40px auto;">
            <h2 style="text-align: center; margin-top: 0;">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
            <input id="prod-desc" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä. –ê–∫–∫–∞—É–Ω—Ç Steam)">
            <input type="number" id="prod-price" placeholder="–¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö">
            <input type="number" id="prod-stock" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ" value="1">
            <button onclick="publish()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç–µ</button>
        </div>
    </div>

    <div id="chats" class="page">
        <div class="chat-wrap">
            <div id="contact-list" class="chat-list"></div>
            <div id="chat-active" class="chat-main">
                <div style="text-align: center; margin: auto; opacity: 0.2;">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</h3>
                </div>
            </div>
        </div>
    </div>

    <div id="adm-page" class="page">
        <h2 style="color: var(--admin);">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
        <div class="card">
            <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –†–µ–π—Ç–∏–Ω–≥</h3>
            <div id="adm-users"></div>
        </div>
        <div class="card">
            <h3>–í—Å–µ —Ç–æ–≤–∞—Ä—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ</h3>
            <div id="adm-items"></div>
        </div>
        <button onclick="wipeAllData()" class="secondary" style="border: 1px solid var(--admin); color: var(--admin);">–°–ë–†–û–°–ò–¢–¨ –í–°–Æ –°–ò–°–¢–ï–ú–£</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyApfEncKdafvvXaUmtTclPiDJPyrcuD7SQ",
        authDomain: "greenpay-34957.firebaseapp.com",
        projectId: "greenpay-34957",
        storageBucket: "greenpay-34957.firebasestorage.app",
        messagingSenderId: "990792295519",
        appId: "1:990792295519:web:5ba691f1f8eb896db8a7ea"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let user = localStorage.getItem('gp_nick') || "";
    let isAdmin = false;

    if(user) document.getElementById('auth-overlay').style.display = 'none';

    async function handleAuth() {
        const n = document.getElementById('nick-in').value.trim();
        const p = document.getElementById('pass-in').value;
        if(!n || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
        const uRef = db.collection("users").doc(n);
        const d = await uRef.get();
        if(d.exists && d.data().pass !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
        if(!d.exists) await uRef.set({ nick: n, pass: p, rating: 5.0 });
        localStorage.setItem('gp_nick', n);
        location.reload();
    }

    function logout() { localStorage.removeItem('gp_nick'); location.reload(); }

    function setPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-links span').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(el) el.classList.add('active');
        if(id === 'chats') document.getElementById('chat-link').classList.remove('dot');
        if(id === 'adm-page') renderAdmin();
        window.scrollTo(0,0);
    }

    // –†–µ–Ω–¥–µ—Ä –ú–∞—Ä–∫–µ—Ç–∞
    db.collection("items").orderBy("t", "desc").onSnapshot(snap => {
        const list = document.getElementById('market-render');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `
                <div class="product">
                    <div>
                        <h3>${d.desc}</h3>
                        <small style="opacity:0.5">–ü—Ä–æ–¥–∞–≤–µ—Ü: ${d.seller}</small>
                        <div class="price">${d.price} ‚ÇΩ</div>
                        <div style="font-size:12px; margin-bottom:15px;">
                            –†–µ–π—Ç–∏–Ω–≥: <span style="color:var(--green)">‚òÖ ${parseFloat(d.rating).toFixed(1)}</span> | –í –Ω–∞–ª–∏—á–∏–∏: ${d.stock}
                        </div>
                    </div>
                    <button onclick="startChat('${d.seller}')">–ö—É–ø–∏—Ç—å / –ß–∞—Ç</button>
                </div>`;
        });
    });

    async function publish() {
        const d = document.getElementById('prod-desc').value;
        const p = document.getElementById('prod-price').value;
        const s = document.getElementById('prod-stock').value;
        if(!d || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
        const u = await db.collection("users").doc(user).get();
        await db.collection("items").add({ desc: d, price: p, stock: s, seller: user, t: Date.now(), rating: u.data().rating });
        setPage('market');
    }

    // –ß–∞—Ç—ã
    function startChat(seller) {
        if(seller === user) return;
        const id = [user, seller].sort().join("_");
        db.collection("chats").doc(id).set({ users: [user, seller], last: Date.now(), unread: seller }, {merge: true});
        setPage('chats');
        loadMessages(id, seller);
    }

    function loadMessages(id, other) {
        db.collection("chats").doc(id).update({ unread: "" });
        const box = document.getElementById('chat-active');
        box.innerHTML = `
            <div style="padding:15px; background: rgba(0,0,0,0.2); font-weight:bold; border-bottom:1px solid var(--glass)">${other}</div>
            <div id="msg-area" class="messages"></div>
            <div style="padding:15px; background: rgba(0,0,0,0.3); display:flex; gap:10px;">
                <input id="m-in" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
                <button onclick="sendMsg('${id}')" style="width:80px; margin:0">></button>
            </div>`;
        
        db.collection("chats").doc(id).collection("messages").orderBy("t").onSnapshot(snap => {
            const area = document.getElementById('msg-area');
            if(!area) return; area.innerHTML = "";
            snap.forEach(m => {
                const d = m.data();
                area.innerHTML += `<div class="msg ${d.f === user ? 'me' : 'other'}">${d.m}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function sendMsg(id) {
        const m = document.getElementById('m-in').value;
        if(!m) return;
        const other = id.split('_').find(u => u !== user);
        db.collection("chats").doc(id).collection("messages").add({ f: user, m, t: Date.now() });
        db.collection("chats").doc(id).update({ last: Date.now(), unread: other });
        document.getElementById('m-in').value = "";
    }

    db.collection("chats").where("users", "array-contains", user).onSnapshot(snap => {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        let hasUnread = false;
        snap.forEach(c => {
            const d = c.data();
            const other = d.users.find(u => u !== user);
            const isUnread = d.unread === user;
            if(isUnread) hasUnread = true;
            list.innerHTML += `<div class="chat-item ${isUnread ? 'unread' : ''}" onclick="loadMessages('${c.id}', '${other}')">üí¨ ${other}</div>`;
        });
        if(hasUnread) document.getElementById('chat-link').classList.add('dot');
    });

    // –ê–¥–º–∏–Ω–∫–∞
    window.addEventListener('keydown', e => {
        if(e.key === "F2" && prompt("–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:") === "000") {
            isAdmin = true;
            document.getElementById('adm-badge').style.display = 'inline';
            document.getElementById('adm-link').style.display = 'inline';
            alert("–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤–∫–ª—é—á–µ–Ω");
        }
    });

    function renderAdmin() {
        // –Æ–∑–µ—Ä—ã
        db.collection("users").onSnapshot(snap => {
            const box = document.getElementById('adm-users'); box.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                box.innerHTML += `
                <div class="admin-item">
                    <span>${u.nick} (‚òÖ${parseFloat(u.rating).toFixed(1)})</span>
                    <div style="display:flex; gap:5px;">
                        <input id="r-${u.nick}" type="number" placeholder="0-5" style="width:60px; margin:0; padding:5px;">
                        <button onclick="updateRating('${u.nick}')" style="width:50px; padding:5px; margin:0;">OK</button>
                        <button onclick="db.collection('users').doc('${u.nick}').delete()" style="background:var(--admin); width:50px; padding:5px; margin:0;">BAN</button>
                    </div>
                </div>`;
            });
        });
        // –í—Å–µ —Ç–æ–≤–∞—Ä—ã
        db.collection("items").onSnapshot(snap => {
            const box = document.getElementById('adm-items'); box.innerHTML = "";
            snap.forEach(d => {
                box.innerHTML += `
                <div class="admin-item">
                    <span>${d.data().desc} (${d.data().seller})</span>
                    <button onclick="db.collection('items').doc('${d.id}').delete()" style="background:var(--admin); width:80px; margin:0; padding:5px;">–£–¥–∞–ª–∏—Ç—å</button>
                </div>`;
            });
        });
    }

    async function updateRating(nick) {
        let val = parseFloat(document.getElementById('r-'+nick).value);
        if(isNaN(val)) return;
        if(val > 5) val = 5; if(val < 0) val = 0;
        await db.collection("users").doc(nick).update({ rating: val });
        const items = await db.collection("items").where("seller", "==", nick).get();
        items.forEach(it => db.collection("items").doc(it.id).update({ rating: val }));
        alert("–†–µ–π—Ç–∏–Ω–≥ " + nick + " –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ " + val);
    }

    async function wipeAllData() {
        if(confirm("–í–´ –£–í–ï–†–ï–ù–´? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å—Ç–µ—Ä—Ç—ã!")) {
            ['users','items','chats'].forEach(async col => {
                const s = await db.collection(col).get();
                s.forEach(d => d.ref.delete());
            });
            location.reload();
        }
    }
</script>
</body>
</html>
